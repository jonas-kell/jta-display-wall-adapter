services:
  build-frontend:
    image: node:20
    working_dir: /app/
    volumes:
      - ./web_client:/app/
    environment:
      - VITE_WS_IP=127.0.0.1
      - VITE_WS_PORT=6789
    command: >
      bash -c "
        npm install &&
        npm run build
      "

  client-run:
    build:
      context: ./
      dockerfile: ./docker/run/Dockerfile
    depends_on:
      build-frontend:
        condition: service_completed_successfully
    environment:
      - DISPLAY=${DISPLAY}
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:ro
      - ${XAUTHORITY}:/root/.Xauthority:ro
    devices:
      - /dev/dri:/dev/dri
    ports:
      - "5678:5678"
    command: /app/client client --display-client-communication-port 5678
